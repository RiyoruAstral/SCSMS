<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.niit.mapper.StudentCourseSelectionMapper">

    <select id="findStudentCourseSelectionBySno" resultType="com.niit.pojo.StudentCourseSelection">
        SELECT
        c.cNo AS cNo,
        c.cName AS cName,
        c.credit AS credit,
        CONCAT(t.tName, '（', t.tDuty, '）') AS teacher,
        CONCAT(sch.dayOfWeek, ' ',
        CASE WHEN sch.duration = 1 THEN CONCAT(sch.startTime, '节')
        ELSE CONCAT(sch.startTime, '-', (sch.startTime + sch.duration - 1), '节') END) AS startTime,
        cr.location AS location,
        (c.capacity - COUNT(DISTINCT cs.sNo)) AS remainingStudent,
        CASE WHEN cs.sNo IS NOT NULL THEN '已选' ELSE '未选' END AS flag,
        IFNULL(GROUP_CONCAT(DISTINCT pc.cName ORDER BY pc.cName SEPARATOR ', '), '无') AS prerequisite
        FROM
        course c
        JOIN
        teaching th ON c.cNo = th.cNo
        JOIN
        teacher t ON th.tNo = t.tNo
        JOIN
        courseschedule sch ON c.cNo = sch.cNo
        JOIN
        classroom cr ON sch.classroomId = cr.classroomId
        LEFT JOIN
        prerequisite cp ON c.cNo = cp.courseId
        LEFT JOIN
        course pc ON cp.prerequisiteId = pc.cNo  -- 先修课程表别名pc
        LEFT JOIN
        courseselection cs ON c.cNo = cs.cNo AND cs.sNo = #{sno}
        WHERE
        c.courseType = '选修'
        AND c.courseCategory = '专业选修'
        AND c.dNo = (SELECT dNo FROM student WHERE sNo = #{sno})
        <if test="startTime != 0">AND sch.startTime = #{startTime}</if>
        <if test="dayOfWeek != 0">AND sch.dayOfWeek = #{dayOfWeek}</if>
        GROUP BY
        c.cNo, c.cName, c.credit, c.capacity, t.tName, t.tDuty,
        sch.dayOfWeek, sch.startTime, sch.duration, cr.location, cs.sNo
        ORDER BY
        c.cNo, sch.dayOfWeek, sch.startTime;


    </select>
</mapper>